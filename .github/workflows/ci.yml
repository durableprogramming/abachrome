name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby-version: ['3.0', '3.1', '3.2', '3.3']

    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true
    - name: Run tests
      run: bundle exec rake test
    - name: Run RuboCop
      run: bundle exec rubocop

  security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true
    - name: Run bundle audit
      run: bundle exec bundle audit --update
    - name: Run Brakeman
      run: |
        gem install brakeman
        brakeman --exit-on-warn --format sarif --output brakeman.sarif
      continue-on-error: true
    - name: Upload Brakeman results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: brakeman.sarif
      if: always()

  release:
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true
    - name: Run tests
      run: bundle exec rake test
    - name: Build gem
      run: gem build abachrome.gemspec
    - name: Generate checksums
      run: |
        sha256sum abachrome-*.gem > abachrome-${{ github.ref_name }}.gem.sha256
    - name: Generate SBOM
      run: |
        gem install cyclonedx-ruby
        cyclonedx-ruby -p abachrome.gemspec -o abachrome-${{ github.ref_name }}-sbom.json
    - name: Sign gem (if GPG key available)
      run: |
        if [ -n "$GPG_PRIVATE_KEY" ]; then
          echo "$GPG_PRIVATE_KEY" | gpg --import --batch --yes
          gpg --detach-sign --armor abachrome-*.gem
        fi
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          abachrome-*.gem
          abachrome-*.gem.sha256
          abachrome-*-sbom.json
          abachrome-*.gem.asc